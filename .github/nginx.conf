server {
    listen 80;
    listen [::]:80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # CRITICAL: Headers for SharedArrayBuffer/threading support
    # These headers are MANDATORY for Godot 4.5 web exports with threading
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Resource-Policy "cross-origin" always;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/javascript application/javascript application/json application/wasm;

    # Main location block
    location / {
        try_files $uri $uri/ /index.html;
        
        # Disable caching for HTML files to ensure fresh content
        location ~* \.(html|htm)$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            # Repeat COOP/COEP headers for HTML files
            add_header Cross-Origin-Opener-Policy "same-origin" always;
            add_header Cross-Origin-Embedder-Policy "require-corp" always;
        }
    }

    # WebAssembly files - Critical for Godot
    location ~* \.wasm$ {
        add_header Content-Type "application/wasm" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # Pre-compressed WebAssembly (if using Godot's compression)
    location ~* \.wasm\.(gz|br)$ {
        gzip off;
        add_header Content-Encoding "gzip" always;
        add_header Content-Type "application/wasm" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # Godot data files (.pck)
    location ~* \.(pck|data)$ {
        add_header Content-Type "application/octet-stream" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # JavaScript files
    location ~* \.js$ {
        add_header Content-Type "application/javascript" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # Audio files (if your game has them)
    location ~* \.(mp3|ogg|wav)$ {
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public" always;
    }

    # Image files
    location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public" always;
    }

    # PWA files
    location /manifest.json {
        add_header Content-Type "application/manifest+json" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 0;
        add_header Cache-Control "no-cache" always;
    }

    location /service-worker.js {
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 0;
        add_header Cache-Control "no-cache" always;
    }

    # Fonts (if your game uses web fonts)
    location ~* \.(ttf|otf|woff|woff2)$ {
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public" always;
    }

    # Define MIME types explicitly
    types {
        application/wasm                      wasm;
        application/javascript                 js;
        application/json                       json;
        application/manifest+json              webmanifest;
        text/html                             html htm;
        text/css                              css;
        image/png                             png;
        image/jpeg                            jpg jpeg;
        image/gif                             gif;
        image/svg+xml                         svg;
        image/webp                            webp;
        audio/mpeg                            mp3;
        audio/ogg                             ogg;
        audio/wav                             wav;
        font/ttf                              ttf;
        font/otf                              otf;
        font/woff                             woff;
        font/woff2                            woff2;
    }
}